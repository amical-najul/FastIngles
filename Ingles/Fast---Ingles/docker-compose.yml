version: '3.8'

# Fast-Ingles Infrastructure
# 4 Containers: PostgreSQL, MinIO, Backend, Frontend
# Networks: Database, Storage, Public

services:
  # 1. PostgreSQL Database (DISABLED - Using Supabase)
  # postgres_db:
  #   image: postgres:16-alpine
  #   container_name: postgres-FastIngles
  #   restart: unless-stopped
  #   environment:
  #     POSTGRES_USER: postgres
  #     POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
  #     POSTGRES_DB: fastingles
  #   volumes:
  #     - vol-postgres-data:/var/lib/postgresql/data
  #     - ./backend/init.sql:/docker-entrypoint-initdb.d/init.sql
  #   ports:
  #     - "5432:5432"
  #   healthcheck:
  #     test: [ "CMD-SHELL", "pg_isready -U postgres" ]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   networks:
  #     - net-database

  # 2. MinIO Object Storage
  # Service: minio_server
  # Container: minio-FastIngles
  # ... (Keep existing comments or layout if needed)

  # 4. Backend API
  # Service: backend_api
  # Container: Backend-FastApi-FastIngles
  backend_api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: Backend-FastApi-FastIngles
    restart: unless-stopped
    env_file:
      - ./backend/.env
    environment:
      # Using container names as hostnames for clarity and stability across networks
      # DATABASE_URL: Managed in .env now (Supabase)
      # MinIO External (Values loaded from env_file)
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-files.n8nprueba.shop}
      MINIO_BUCKET: ${MINIO_BUCKET:-fastingles}
      MINIO_SECURE: "true"
    ports:
      - "8000:8000"
    networks:
      - net-database
      - net-storage
      - net-public

  # 5. Frontend App
  # Service: frontend_app
  # Container: Frontend-React-FastIngles
  frontend_app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: Frontend-React-FastIngles
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      - backend_api
    networks:
      - net-public

# Dedicated Volumes
volumes:
  vol-postgres-data:
    driver: local
  vol-minio-data:
    driver: local
    name: fast-ingles-minio-bucket-store

# Network Segmentation
networks:
  net-database:
    driver: bridge
  net-storage:
    driver: bridge
  net-public:
    driver: bridge
