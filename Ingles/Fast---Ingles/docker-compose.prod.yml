version: '3.8'

services:
  backend_api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: fast-ingles-backend
    restart: always
    # REMOVED: env_file support to favor Portainer UI Environment Variables
    # env_file:
    #   - .env
    environment:
      # --- App Settings ---
      - APP_NAME=Fast-Ingles VPS
      - DEBUG=false

      # --- Database (Legacy - Supabase pooler) ---
      - DATABASE_URL=${DATABASE_URL}

      # --- Supabase REST API (REQUIRED) ---
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}

      # --- Security ---
      - SECRET_KEY=${SECRET_KEY}
      - ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=30

      # --- AI Provider ---
      - DEFAULT_AI_PROVIDER=gemini
      - GEMINI_API_KEY=${GEMINI_API_KEY}

      # --- MinIO (Storage) ---
      - MINIO_ENDPOINT=files.n8nprueba.shop
      - MINIO_BUCKET=fastingles
      - MINIO_SECURE=true
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}

      # --- Firebase (REQUIRED for token verification) ---
      - GOOGLE_CLOUD_PROJECT=ingles-54212

      # --- CORS ---
      - CORS_ORIGINS=${CORS_ORIGINS:-["https://ingles.n8nprueba.shop"]}

    healthcheck:
      test: [ "CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/health')" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    networks:
      default:
        aliases:
          - backend_api
      traefik_proxy:
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_proxy"

      # Router para API (captura /api, /docs, /redoc)
      - "traefik.http.routers.ingles-api.rule=Host(`ingles.n8nprueba.shop`) && PathPrefix(`/api`, `/docs`, `/redoc`, `/openapi.json`)"
      - "traefik.http.routers.ingles-api.entrypoints=websecure"
      - "traefik.http.routers.ingles-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.ingles-api.priority=100"
      - "traefik.http.services.ingles-api.loadbalancer.server.port=8000"

      # CORS Headers (MUST include Authorization for Firebase tokens)
      - "traefik.http.middlewares.api-cors.headers.accesscontrolalloworiginlist=https://ingles.n8nprueba.shop"
      - "traefik.http.middlewares.api-cors.headers.accesscontrolallowmethods=GET,POST,PUT,DELETE,OPTIONS"
      - "traefik.http.middlewares.api-cors.headers.accesscontrolallowheaders=Authorization,Content-Type,Accept,Origin,X-Requested-With"
      - "traefik.http.middlewares.api-cors.headers.accesscontrolallowcredentials=true"
      - "traefik.http.middlewares.api-cors.headers.accesscontrolmaxage=86400"
      - "traefik.http.routers.ingles-api.middlewares=api-cors"

  frontend_app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fast-ingles-frontend
    restart: always
    depends_on:
      - backend_api
    networks:
      - default
      - traefik_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_proxy"

      # Router para Frontend (Todo lo dem√°s)
      - "traefik.http.routers.ingles-web.rule=Host(`ingles.n8nprueba.shop`)"
      - "traefik.http.routers.ingles-web.entrypoints=websecure"
      - "traefik.http.routers.ingles-web.tls.certresolver=letsencrypt"
      - "traefik.http.routers.ingles-web.priority=1"
      - "traefik.http.services.ingles-web.loadbalancer.server.port=80"

networks:
  traefik_proxy:
    external: true
